---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { loadEvents } from "../../lib/load";

export function getStaticPaths() {
  const { events } = loadEvents();
  return events.map((e) => ({ params: { slug: e.slug } }));
}

const { slug } = Astro.params;
const { events } = loadEvents();
const event = events.find((e) => e.slug === slug);

function pct(p) {
  return `${Math.round(p * 100)}%`;
}

function edgeFmt(x) {
  if (x === null || x === undefined) return "—";
  const v = Number(x);
  const sign = v >= 0 ? "+" : "";
  return `${sign}${(v * 100).toFixed(1)}%`;
}
---
<BaseLayout title={event ? event.event_name : "Event"}>
  {!event ? (
    <section class="card">Event not found.</section>
  ) : (
    <>
      <section class="card">
        <h1 style="margin:0 0 6px 0;">{event.event_name}</h1>
        <div class="small">{event.event_date_utc} {event.location ? `• ${event.location}` : ""}</div>
        <div class="small" style="margin-top:8px;">
          Affiliate links can be placed here later (v1 keeps this minimal).
        </div>
      </section>

      <section class="card">
        <h2 style="margin:0 0 10px 0;">Card</h2>
        <table class="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Bout</th>
              <th>Model</th>
              <th>Odds</th>
              <th>Edge</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody>
            {event.bouts.map((b) => (
              <tr>
                <td>{b.bout_order}</td>
                <td>
                  <div style="font-weight:700;">
                    {b.fighter_a} vs {b.fighter_b}
                  </div>
                  <div class="small">
                    {b.weight_class_lbs ? `${b.weight_class_lbs} lbs` : "—"}
                  </div>
                </td>
                <td>
                  {b.prediction ? (
                    <>
                      <div class="badge">{b.prediction.confidence} confidence</div>
                      <div class="small" style="margin-top:6px;">
                        A: {pct(b.prediction.p_a)} • B: {pct(b.prediction.p_b)}
                      </div>
                    </>
                  ) : (
                    "—"
                  )}
                </td>
                <td class="small">
                  {b.odds ? (
                    <>
                      <div>{b.odds.book}</div>
                      <div>A: {b.odds.odds_a_american} • B: {b.odds.odds_b_american}</div>
                      <div class="small">{b.odds.odds_timestamp_utc}</div>
                    </>
                  ) : (
                    "—"
                  )}
                </td>
                <td class="small">
                  {b.prediction ? (
                    <>
                      <div>A: {edgeFmt(b.prediction.edge_a)}</div>
                      <div>B: {edgeFmt(b.prediction.edge_b)}</div>
                    </>
                  ) : (
                    "—"
                  )}
                </td>
                <td class="small">
                  {b.outcome ? (
                    <div>Winner: {b.outcome.winner} {b.outcome.method ? `(${b.outcome.method})` : ""}</div>
                  ) : (
                    "—"
                  )}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </section>
    </>
  )}
</BaseLayout>
