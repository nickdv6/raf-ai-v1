import BaseLayout from "../../layouts/BaseLayout.astro";
import siteData from "../../data/events.json";
import { affiliateConfig } from "../../config/affiliate";
import { FEATURES } from "../../config/features.ts";
import { ACTIVE_TIER } from "../../config/access.ts";

export function getStaticPaths() {
  const events = siteData?.events ?? [];
  return events
    .filter((e) => e?.slug)
    .map((e) => ({ params: { slug: e.slug } }));
}

const { slug } = Astro.params;

const events = siteData?.events ?? [];
const event = events.find((e) => e?.slug === slug) ?? null;

// Compute "Last updated" timestamp from latest odds update across all bouts
const lastUpdatedIso = (() => {
  if (!event?.bouts?.length) return event?.event_date_utc ?? null;

  const timestamps = event.bouts
    .map((b) => b?.odds?.odds_timestamp_utc)
    .filter(Boolean)
    .map((t) => new Date(t))
    .filter((d) => !Number.isNaN(d.getTime()));

  if (timestamps.length === 0) return event?.event_date_utc ?? null;

  const latest = new Date(Math.max(...timestamps.map((d) => d.getTime())));
  return latest.toISOString();
})();

const fmtDateTime = (iso) => {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return String(iso);
  return d.toLocaleString(undefined, {
    year: "numeric",
    month: "short",
    day: "numeric",
    hour: "numeric",
    minute: "2-digit",
  });
};

const fmtProb = (p) => {
  const n = Number(p);
  if (!Number.isFinite(n)) return "";
  return `${Math.round(n * 100)}%`;
};

const fmtEdge = (e) => {
  const n = Number(e);
  if (!Number.isFinite(n)) return "";
  const pct = n * 100;
  const sign = pct >= 0 ? "+" : "";
  return `${sign}${pct.toFixed(1)}%`;
};

const fmtAmericanOdds = (o) => {
  const n = Number(o);
  if (!Number.isFinite(n)) return "";
  return n > 0 ? `+${n}` : `${n}`;
};

const features = FEATURES[ACTIVE_TIER];

const upgradeTitle =
  ACTIVE_TIER === "basic" ? "Unlock Forge Pro features" : "Upgrade for more tools";

const upgradeBody =
  ACTIVE_TIER === "basic"
    ? "Forge Pro unlocks edge sorting/filtering and Pro-only market tools."
    : "Forge Basic adds historical access. Forge Pro unlocks edge sorting/filtering and Pro-only tools.";

const pageTitle = event?.event_name
  ? `${event.event_name} — Signal Forge Sports`
  : "Event — Signal Forge Sports";

const base = import.meta.env.BASE_URL;

const bouts = (event?.bouts ?? [])
  .slice()
  .sort((a, b) => (a?.bout_order ?? 0) - (b?.bout_order ?? 0));

const confidenceKey = (c) => (typeof c === "string" ? c.trim().toLowerCase() : "");

const highlightCandidates = bouts
  .map((b) => {
    const edgeA = Number(b?.prediction?.edge_a ?? NaN);
    const edgeB = Number(b?.prediction?.edge_b ?? NaN);

    const conf = b?.prediction?.confidence;
    if (confidenceKey(conf) === "low") return null;

    const pick =
      Number.isFinite(edgeA) && Number.isFinite(edgeB)
        ? edgeA >= edgeB
          ? { side: "A", edge: edgeA }
          : { side: "B", edge: edgeB }
        : Number.isFinite(edgeA)
        ? { side: "A", edge: edgeA }
        : Number.isFinite(edgeB)
        ? { side: "B", edge: edgeB }
        : null;

    if (!pick || !(pick.edge > 0)) return null;

    return {
      boutId: b?.bout_id,
      boutOrder: b?.bout_order,
      weightClass: b?.weight_class_lbs,
      fighter: pick.side === "A" ? b?.fighter_a : b?.fighter_b,
      opponent: pick.side === "A" ? b?.fighter_b : b?.fighter_a,
      side: pick.side,
      edge: pick.edge,
      confidence: conf,
      prob: pick.side === "A" ? b?.prediction?.p_a : b?.prediction?.p_b,
      book: b?.odds?.book,
      oddsAmerican:
        pick.side === "A"
          ? b?.odds?.odds_a_american
          : b?.odds?.odds_b_american,
      oddsTimestamp: b?.odds?.odds_timestamp_utc,
    };
  })
  .filter(Boolean);

const bestHighlight =
  highlightCandidates.length > 0
    ? highlightCandidates.sort((a, b) => b.edge - a.edge)[0]
    : null;

const highlightAnchor = bestHighlight?.boutId
  ? `#bout-${bestHighlight.boutId}`
  : "";
---

<BaseLayout title={pageTitle}>
  {event ? (
    <div id="top" style="display:grid;gap:16px;">
      <!-- Event Header -->
      <section class="card">
        <div style="display:flex;justify-content:space-between;gap:12px;">
          <div>
            <h1 style="margin:0;">{event.event_name}</h1>
            <div class="small" style="margin-top:8px;">
              {event.event_date_utc ? fmtDateTime(event.event_date_utc) : ""}
              {event.location ? ` • ${event.location}` : ""}
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:8px;">
            {lastUpdatedIso && (
              <span class="pill">Last updated {fmtDateTime(lastUpdatedIso)}</span>
            )}
            <a class="btn btn--sm" href={`${base}`}>Back</a>
            <a class="btn btn--sm" href="#bouts">Bouts</a>
          </div>
        </div>

        <div class="small" style="margin-top:10px;">
          Event ID: <strong>{event.event_id}</strong>
          {event.slug && <> • Slug: <strong>{event.slug}</strong></>}
        </div>
      </section>

      <!-- Card Highlight -->
      <section class="card">
        <h2 style="margin:0;">Card Highlight</h2>
        <div class="small" style="margin-top:6px;">
          Best model-identified pricing inefficiency on this card (excluding low-confidence signals).
        </div>

        {bestHighlight ? (
          <div class="card" style="margin-top:12px;padding:14px;">
            <div style="display:flex;justify-content:space-between;gap:12px;">
              <div>
                <strong>
                  {bestHighlight.fighter} vs {bestHighlight.opponent}
                </strong>
                <div class="small" style="margin-top:6px;">
                  Bout {bestHighlight.boutOrder}
                  {bestHighlight.confidence && ` • ${bestHighlight.confidence} confidence`}
                </div>
              </div>

              <div style="display:flex;flex-direction:column;gap:6px;">
                <span class="pill">Edge {fmtEdge(bestHighlight.edge)}</span>
                <div class="small" style="opacity:0.7;">
                  Edge = difference between model probability and implied odds.
                </div>
                {lastUpdatedIso && (
                  <div class="small" style="opacity:0.6;">
                    Prices last updated {fmtDateTime(lastUpdatedIso)}
                  </div>
                )}
              </div>
            </div>

            <div style="margin-top:12px;">
              <a class="btn btn--sm" href={highlightAnchor}>Jump to bout</a>
            </div>
          </div>
        ) : (
          <div style="margin-top:12px;">
            <strong>No positive edge identified at current prices.</strong>
            <div class="small" style="margin-top:6px;">
              This may change as odds update or market conditions shift.
            </div>
            <div class="small" style="margin-top:6px;opacity:0.7;">
              Edge = difference between model probability and implied odds.
            </div>
          </div>
        )}

        {features.showUpgradePrompt && (
          <div class="card" style="margin-top:12px;padding:14px;">
            <strong>{upgradeTitle}</strong>
            <div class="small" style="margin-top:6px;">
              {upgradeBody}
            </div>
            <div style="margin-top:10px;">
              <a class="btn btn--sm" href={`${base}pricing/`}>View plans</a>
            </div>
          </div>
        )}
      </section>

      <!-- Bouts -->
      <section class="card" id="bouts">
        <h2 style="margin-top:0;">Bouts</h2>

        {bouts.length > 0 ? (
          <div style="display:grid;gap:12px;">
            {bouts.map((b) => (
              <div class="card" id={`bout-${b?.bout_id}`} style="padding:14px;">
                <strong>
                  Bout {b?.bout_order}: {b?.fighter_a} vs {b?.fighter_b}
                </strong>
              </div>
            ))}
          </div>
        ) : (
          <div class="small">No bouts available for this event.</div>
        )}

        <div class="small" style="margin-top:12px;">
          <a href="#top">Back to top</a>
        </div>
      </section>
    </div>
  ) : (
    <section class="card">
      <h1>Event not found</h1>
      <div class="small">
        No event matches slug: <strong>{slug}</strong>
      </div>
      <div style="margin-top:12px;">
        <a class="btn btn--sm" href={`${base}`}>Back</a>
      </div>
    </section>
  )}
</BaseLayout>
